{{template "base" .}}

{{define "title"}}Network Utility Belt{{end}}

{{define "main"}}
<style>
    .hero { margin-bottom: 2rem; }
    .hero h2 { color: var(--dark-bg); margin-bottom: 0.5rem; }
    .hero p { color: var(--text-muted); font-size: 1.1rem; }
    
    .stats-bar {
        display: flex;
        gap: 20px;
        background: var(--dark-bg);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }
    .stat-item span { color: #00ccff; font-weight: bold; }

    .tool-grid { display: flex; flex-direction: column; gap: 1.5rem; }
    
    .card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        min-height: 250px;
    }
    .card-sidebar {
        background: #f1f3f5;
        padding: 1.5rem;
        width: 300px;
        border-right: 1px solid var(--border-color);
    }
    .card-content { flex: 1; padding: 1.5rem; background: #fff; }
    
    input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        margin: 10px 0;
    }
    button {
        width: 100%;
        padding: 10px;
        background: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
    }
    pre {
        background: #2d2d2d;
        color: #61dafb; /* A nice cyan for visibility */
        padding: 1rem;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        margin: 0;
        white-space: pre-wrap;
    }
/* The Spinner CSS */
    .loader {
        width: 18px;
        height: 18px;
        border: 2px solid #61dafb;
        border-bottom-color: transparent;
        border-radius: 50%;
        display: inline-block;
        animation: rotation 1s linear infinite;
        vertical-align: middle;
        margin-right: 10px;
    }
    @keyframes rotation {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .status-msg {
        display: none;
        color: #61dafb;
        font-size: 0.9rem;
        margin-top: 10px;
    }
    .result-container { min-height: 50px; }
</style>

<div class="hero">
    <h2>Grounded IT for Growing Organizations</h2>
    <p>Security-focused network infrastructure for Leavenworth, KS.</p>
</div>

<div class="stats-bar">
    <div class="stat-item">AnchorPoint Gateway: <span>{{.ServerPublicIP}}</span></div>
    <div class="stat-item">Connection: <span>{{.GatewayStatus}}</span></div>
</div>

<section class="card" style="margin-bottom: 2rem;">
    <div class="card-sidebar" style="width: 200px;">
        <h3>Path Visualization</h3>
        <p>Geographic route of the last diagnostic.</p>
    </div>
    <div class="card-content">
        <div id="map" style="height: 350px; background: #eee; border-radius: 8px;"></div>
    </div>
</section>

<div class="status-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
    <section class="card" style="display: flex; flex-direction: row; height: 250px;">
        <div style="flex: 0 0 140px; padding: 15px; border-right: 1px solid #eee;">
            <h3 style="margin:0;">Docker</h3>
            <button onclick="refreshDocker()" style="width:100%; margin-top:10px;">Refresh</button>
        </div>
        <div style="flex-grow: 1; background: #222; color: #fff; padding: 10px; overflow-y: auto;">
            <pre id="docker-output" style="margin:0; font-size: 0.8rem;">{{.DockerContainers}}</pre>
        </div>
    </section>

    <section class="card" style="display: flex; flex-direction: row; height: 250px;">
        <div style="flex: 0 0 140px; padding: 15px; border-right: 1px solid #eee;">
            <h3 style="margin:0;">Logs</h3>
            <button onclick="refreshLogs()" style="width:100%; margin-top:10px;">Refresh</button>
        </div>
        <div style="flex-grow: 1; background: #1a1a1a; color: #0f0; padding: 10px; overflow-y: auto;">
            <pre id="log-output" style="margin:0; font-size: 0.8rem;">Awaiting logs...</pre>
        </div>
    </section>
</div>

    <section class="card" style="display: flex; flex-direction: row;">
        <div class="card-sidebar" style="flex: 0 0 180px; padding: 15px;">
            <h3 style="margin-top: 0;">System Logs</h3>
            <p style="font-size: 0.85rem;">Recent activity.</p>
            <button onclick="refreshLogs()" style="width: 100%; padding: 8px; font-size: 0.9rem;">Refresh</button>
        </div>
        <div class="card-content" style="flex-grow: 1; overflow: hidden; border-left: 1px solid #eee;">
            <pre id="log-output" style="height: 200px; margin: 0; padding: 10px; font-size: 0.8rem; background: #1e1e1e; color: #00ff00; overflow-y: auto;">Awaiting logs...</pre>
        </div>
    </section>
</div>

<div class="tool-grid">
    <section class="card">
        <div class="card-sidebar">
            <h3>ICMP Ping</h3>
            <p>Check reachability for a specific IP or host.</p>
            <input type="text" id="ping_ip" placeholder="8.8.8.8" required>
            <button onclick="runDiagnostic('ping')">Execute Ping</button>
            
            <div id="ping-status" class="status-msg">
                <span class="loader"></span> Sending ICMP echo requests...
            </div>
        </div>
        <div class="card-content result-container">
            <pre id="ping-output">Submit a host to begin.</pre>
        </div>
    </section>

    <section class="card">
        <div class="card-sidebar">
            <h3>Traceroute</h3>
            <p>Identify the network path and hop latency.</p>
            <input type="text" id="trace_ip" placeholder="google.com" required>
            <button onclick="runDiagnostic('trace')">Run Trace</button>
            
            <div id="trace-status" class="status-msg">
                <span class="loader"></span> Tracing network path...
            </div>
        </div>
        <div class="card-content result-container">
            <pre id="trace-output">Awaiting input...</pre>
        </div>
    </section>
</div>
<div class="tool-grid">
    <section class="card">
        <div class="card-sidebar">
            <h3>MTR Report</h3>
            <p>Full path analysis with packet loss metrics.</p>
            <input type="text" id="mtr_ip" placeholder="1.1.1.1" required>
            <button onclick="runDiagnostic('mtr')">Generate MTR</button>
            
            <div id="mtr-status" class="status-msg">
                <span class="loader"></span> Analyzing network path...
            </div>
        </div>
        <div class="card-content result-container">
            <pre id="mtr-output">Awaiting input...</pre>
        </div>
    </section>
    
    </div>

    <div class="tool-grid">
    <section class="card">
        <div class="card-sidebar">
            <h3>ISP Speedtest</h3>
            <p>Measure bandwidth from the AnchorPoint Gateway.</p>
            <button onclick="runDiagnostic('speedtest')">Run Speedtest</button>
            <div id="speedtest-status" class="status-msg">
                <span class="loader"></span> Testing throughput...
            </div>
        </div>
        <div class="card-content">
            <pre id="speedtest-output">Awaiting test...</pre>
        </div>
    </section>

    <section class="card">
        <div class="card-sidebar">
            <h3>iPerf3 Client</h3>
            <p>Test point-to-point throughput to a remote iPerf server.</p>
            <input type="text" id="iperf_ip" placeholder="iperf.server.com">
            <button onclick="runDiagnostic('iperf')">Execute iPerf</button>
            <div id="iperf-status" class="status-msg">
                <span class="loader"></span> Running 10s stress test...
            </div>
        </div>
        <div class="card-content">
            <pre id="iperf-output">Target required...</pre>
        </div>
    </section>
</div>

<script>
    // Initialize map
    let map = L.map('map').setView([39.3114, -94.9225], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let markers = [];
    let polyline = null;

    async function runDiagnostic(type) {
        const inputField = document.getElementById(type + '_ip');
        const ip = inputField ? inputField.value : "";
        const output = document.getElementById(type + '-output');
        const status = document.getElementById(type + '-status');

        if (type !== 'speedtest' && !ip) return;

        output.textContent = "Running diagnostic...";
        status.style.display = "block";

        let bodyData = new URLSearchParams();
        if (type === 'speedtest') {
            bodyData.append('speedtest_run', 'true');
        } else {
            bodyData.append(type + '_ip', ip);
        }

        try {
            const response = await fetch('/', {
                method: 'POST',
                headers: { 'Accept': 'application/json' },
                body: bodyData
            });
            const data = await response.json();
            output.textContent = data.output;
            status.style.display = "none";
            if (data.coords) updateMap(data.coords);
        } catch (err) {
            status.style.display = "none";
            output.textContent = "Error: " + err;
        }
    }

    async function refreshDocker() {
        const output = document.getElementById('docker-output');
        output.textContent = "Refreshing...";
        try {
            const response = await fetch('/?refresh=docker');
            output.textContent = await response.text();
        } catch (err) { output.textContent = "Error: " + err; }
    }

    async function refreshLogs() {
        const output = document.getElementById('log-output');
        output.textContent = "Fetching logs...";
        try {
            const response = await fetch('/?refresh=logs');
            const text = await response.text();
            output.textContent = text || "Log file is empty.";
        } catch (err) { output.textContent = "Error: " + err; }
    }

    function updateMap(coords) {
        markers.forEach(m => map.removeLayer(m));
        if (polyline) map.removeLayer(polyline);
        markers = [];
        if (!coords || coords.length === 0) return;
        const latLngs = coords.map(c => [c.lat, c.lon]);
        coords.forEach((c, i) => {
            const m = L.circleMarker([c.lat, c.lon], {radius: 5}).addTo(map).bindPopup(c.ip);
            markers.push(m);
        });
        polyline = L.polyline(latLngs, {color: 'blue'}).addTo(map);
        map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
    }
</script>

{{end}}