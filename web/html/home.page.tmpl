{{template "base" .}}
{{define "main"}}
<div style="display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 24px;">
    <div class="card" style="padding: 0; overflow: hidden; display: flex; flex-direction: column;">
        <div style="padding: 15px; border-bottom: 1px solid var(--stroke);"><h3 style="margin: 0; font-size: 0.85rem; color: var(--teal);">Network Path Visualization</h3></div>
        <div id="map" style="flex-grow: 1; min-height: 500px;"></div>
    </div>
    <div style="display: flex; flex-direction: column; gap: 24px;">
        <div class="card">
            <h3>Diagnostic Tools</h3>
            <input type="text" id="diag_ip" placeholder="Target IP" style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--stroke); color: #fff; border-radius: 8px; margin-bottom: 15px;">
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                <button onclick="runNewDiag('ping')" class="btn">Ping</button>
                <button onclick="runNewDiag('trace')" class="btn">Trace</button>
                <button id="iperf-server-btn" onclick="runIperfServer()" class="btn" style="border-color: var(--teal);">iPerf Server</button>
            </div>
            <pre id="diag-output" style="margin-top: 15px; min-height: 200px;"></pre>
        </div>
        <div class="card">
            <h3>ISP Speedtest</h3>
            <button onclick="runNewDiag('speedtest')" class="btn primary" style="width: 100%;">Execute Test</button>
            <pre id="speedtest-output" style="margin-top: 15px;"></pre>
        </div>
    </div>
</div>
<script>
    let map;
    document.addEventListener('DOMContentLoaded', () => {
        map = L.map('map').setView([39.3114, -94.9225], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    });
    async function runNewDiag(type) {
        const out = document.getElementById(type === 'speedtest' ? 'speedtest-output' : 'diag-output');
        const ip = document.getElementById('diag_ip').value;
        out.textContent = "Running " + type + "...";
        const body = new URLSearchParams();
        type === 'speedtest' ? body.append('speedtest_run', 'true') : body.append(type+'_ip', ip);
        const res = await fetch('/', { method: 'POST', body, headers: {'Accept': 'application/json'} });
        const data = await res.json();
        out.textContent = data.output;
    }
    function runIperfServer() {
        const btn = document.getElementById('iperf-server-btn');
        btn.innerText = "Listening...";
        const body = new URLSearchParams();
        body.append('iperf_server_run', 'true');
        fetch('/', { method: 'POST', body, headers: {'Accept': 'application/json'} })
        .then(r => r.json()).then(d => {
            document.getElementById('diag-output').textContent = d.output;
            btn.innerText = "iPerf Server";
        });
    }
</script>
{{end}}