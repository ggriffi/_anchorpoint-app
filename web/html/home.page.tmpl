{{template "base" .}}

{{define "title"}}Network Utility Belt{{end}}

{{define "main"}}
<div style="display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 24px;">
    <div class="card" style="padding: 0; overflow: hidden; height: 450px; display: flex; flex-direction: column;">
        <div style="padding: 12px; border-bottom: 1px solid var(--stroke); background: rgba(255,255,255,0.03);">
            <h3 style="margin: 0; font-size: 0.8rem; color: var(--teal);">Path Visualization</h3>
        </div>
        <div id="map" style="flex-grow: 1; background: #0b1220;"></div>
    </div>

    <div style="display: flex; flex-direction: column; gap: 24px;">
        <div class="card">
            <h3>Diagnostic Suite</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <input type="text" id="diag_ip" placeholder="Target IP or Hostname" 
                       style="flex-grow: 1; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--stroke); color: white; border-radius: 8px;">
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                <button onclick="runNewDiag('ping')" class="btn">Ping</button>
                <button onclick="runNewDiag('trace')" class="btn">Trace</button>
                <button onclick="runNewDiag('mtr')" class="btn">MTR</button>
                <button onclick="runNewDiag('dns')" class="btn">DNS</button>
                <button onclick="runNewDiag('whois')" class="btn">Whois</button>
                <button onclick="runNewDiag('iperf')" class="btn">iPerf Client</button>
                <button id="iperf-server-btn" onclick="runIperfServer()" class="btn" style="border-color: var(--teal);">iPerf Server</button>
                <button onclick="runNewDiag('iperf_reset')" class="btn" style="border-color: #ef4444; color: #f87171;">Reset Server</button>
            </div>
            <pre id="diag-output" style="margin-top: 15px; height: 300px;"></pre>
        </div>

        <div class="card">
            <h3>Bandwidth Analysis</h3>
            <button onclick="runNewDiag('speedtest')" class="btn primary" style="width: 100%;">Run Speedtest</button>
            <pre id="speedtest-output" style="margin-top: 10px; height: 80px;"></pre>
        </div>
    </div>
</div>

<script>
    let map, markers = [], polyline = null;

    // Initialize Map and UI
    document.addEventListener('DOMContentLoaded', () => {
        map = L.map('map').setView([39.3114, -94.9225], 4);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO'
        }).addTo(map);

        // Setup Auto-scroll Observer
        const diagOutput = document.getElementById('diag-output');
        if (diagOutput) {
            const observer = new MutationObserver(() => {
                diagOutput.scrollTop = diagOutput.scrollHeight;
            });
            observer.observe(diagOutput, { childList: true, characterData: true, subtree: true });
        }
    });

    async function runNewDiag(type) {
        const inputField = document.getElementById('diag_ip');
        const output = document.getElementById(type === 'speedtest' ? 'speedtest-output' : 'diag-output');
        const targetIP = inputField ? inputField.value.trim() : "";

        if (type !== 'speedtest' && type !== 'iperf_reset' && !targetIP) {
            alert("Please enter a target IP or hostname");
            return;
        }

        output.textContent = ">> EXECUTING " + type.toUpperCase() + "...\n";
        
        let bodyData = new URLSearchParams();
        if (type === 'speedtest') {
            bodyData.append('speedtest_run', 'true');
        } else if (type === 'iperf_reset') {
            bodyData.append('iperf_reset', 'true');
        } else {
            bodyData.append(type + '_ip', targetIP);
        }

        try {
            const response = await fetch('/', {
                method: 'POST',
                headers: { 'Accept': 'application/json' },
                body: bodyData
            });
            const data = await response.json();
            output.textContent = data.output;
            
            // Trigger Map Update
            if (data.coords && data.coords.length > 0) {
                updateMap(data.coords);
            }
        } catch (err) {
            output.textContent = "Error: " + err;
        }
    }

    function updateMap(coords) {
        if (!map) return;
        markers.forEach(m => map.removeLayer(m));
        if (polyline) map.removeLayer(polyline);
        markers = [];

        const latLngs = coords.map(c => [c.lat, c.lon]);
        
        coords.forEach(c => {
            const m = L.circleMarker([c.lat, c.lon], {
                radius: 5, color: '#4ade80', fillColor: '#4ade80', fillOpacity: 0.8
            }).addTo(map);
            markers.push(m);
        });

        polyline = L.polyline(latLngs, {
            color: '#4ade80', weight: 2, dashArray: '5, 10', opacity: 0.6
        }).addTo(map);

        if (markers.length > 0) {
            map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
        }
    }

    function runIperfServer() {
        const btn = document.getElementById('iperf-server-btn');
        const output = document.getElementById('diag-output');
        btn.innerText = "Listening...";
        btn.disabled = true;
        
        const bodyData = new URLSearchParams();
        bodyData.append('iperf_server_run', 'true');

        fetch('/', {
            method: 'POST',
            headers: { 'Accept': 'application/json' },
            body: bodyData
        })
        .then(res => res.json())
        .then(data => {
            output.textContent = data.output;
            btn.innerText = "iPerf Server";
            btn.disabled = false;
        });
    }
</script>
{{end}}