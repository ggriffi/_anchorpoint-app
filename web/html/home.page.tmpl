{{template "base" .}}

{{define "title"}}Network Utility Belt{{end}}

{{define "main"}}
<style>
    .hero { margin-bottom: 2rem; }
    .hero h2 { color: var(--dark-bg); margin-bottom: 0.5rem; }
    .hero p { color: var(--text-muted); font-size: 1.1rem; }
    
    .stats-bar {
        display: flex;
        gap: 20px;
        background: var(--dark-bg);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }
    .stat-item span { color: #00ccff; font-weight: bold; }

    .tool-grid { display: flex; flex-direction: column; gap: 1.5rem; }
    
    .card {
        background: white;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        min-height: 250px;
    }
    .card-sidebar {
        background: #f1f3f5;
        padding: 1.5rem;
        width: 300px;
        border-right: 1px solid var(--border-color);
    }
    .card-content { flex: 1; padding: 1.5rem; background: #fff; }
    
    input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        margin: 10px 0;
    }
    button {
        width: 100%;
        padding: 10px;
        background: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
    }
    pre {
        background: #2d2d2d;
        color: #61dafb; /* A nice cyan for visibility */
        padding: 1rem;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        margin: 0;
        white-space: pre-wrap;
    }
/* The Spinner CSS */
    .loader {
        width: 18px;
        height: 18px;
        border: 2px solid #61dafb;
        border-bottom-color: transparent;
        border-radius: 50%;
        display: inline-block;
        animation: rotation 1s linear infinite;
        vertical-align: middle;
        margin-right: 10px;
    }
    @keyframes rotation {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .status-msg {
        display: none;
        color: #61dafb;
        font-size: 0.9rem;
        margin-top: 10px;
    }
    .result-container { min-height: 50px; }
</style>

<div class="hero">
    <h2>Grounded IT for Growing Organizations</h2>
    <p>Security-focused network infrastructure for Leavenworth, KS.</p>
</div>

<div class="stats-bar">
    <div class="stat-item">AnchorPoint Gateway: <span>{{.ServerPublicIP}}</span></div>
    <div class="stat-item">Connection: <span>{{.GatewayStatus}}</span></div>
</div>

<section class="card" style="margin-bottom: 2rem;">
    <div class="card-sidebar" style="width: 200px;">
        <h3>Path Visualization</h3>
        <p>Geographic route of the last diagnostic.</p>
    </div>
    <div class="card-content">
        <div id="map" style="height: 350px; background: #eee; border-radius: 8px;"></div>
    </div>
</section>

<section class="card" style="margin-bottom: 2rem;">
    <div class="card-sidebar" style="width: 200px;">
        <h3>Docker Host</h3>
        <p>Active containers on this Debian node.</p>
    </div>
    <div class="card-content">
        <pre>{{.DockerContainers}}</pre>
    </div>
</section>

<div class="tool-grid">
    <section class="card">
        <div class="card-sidebar">
            <h3>ICMP Ping</h3>
            <p>Check reachability for a specific IP or host.</p>
            <input type="text" id="ping_ip" placeholder="8.8.8.8" required>
            <button onclick="runDiagnostic('ping')">Execute Ping</button>
            
            <div id="ping-status" class="status-msg">
                <span class="loader"></span> Sending ICMP echo requests...
            </div>
        </div>
        <div class="card-content result-container">
            <pre id="ping-output">Submit a host to begin.</pre>
        </div>
    </section>

    <section class="card">
        <div class="card-sidebar">
            <h3>Traceroute</h3>
            <p>Identify the network path and hop latency.</p>
            <input type="text" id="trace_ip" placeholder="google.com" required>
            <button onclick="runDiagnostic('trace')">Run Trace</button>
            
            <div id="trace-status" class="status-msg">
                <span class="loader"></span> Tracing network path...
            </div>
        </div>
        <div class="card-content result-container">
            <pre id="trace-output">Awaiting input...</pre>
        </div>
    </section>
</div>
<div class="tool-grid">
    <section class="card">
        <div class="card-sidebar">
            <h3>MTR Report</h3>
            <p>Full path analysis with packet loss metrics.</p>
            <input type="text" id="mtr_ip" placeholder="1.1.1.1" required>
            <button onclick="runDiagnostic('mtr')">Generate MTR</button>
            
            <div id="mtr-status" class="status-msg">
                <span class="loader"></span> Analyzing network path...
            </div>
        </div>
        <div class="card-content result-container">
            <pre id="mtr-output">Awaiting input...</pre>
        </div>
    </section>
    
    </div>

<script>
let map = L.map('map').setView([39.3114, -94.9225], 4); // Centered on Leavenworth, KS
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

async function runDiagnostic(type) {
    // ... setup logic ...
    const response = await fetch('/', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/x-www-form-urlencoded',
            'Accept': 'application/json' // Ask for JSON now
        },
        body: new URLSearchParams({ [type + '_ip']: ip })
    });

    const data = await response.json();
    output.textContent = data.output; // Set the text results
    
    // Clear old map markers and draw new ones
    updateMap(data.coords);
},
            body: new URLSearchParams({ [type + '_ip']: ip })
        });

        const result = await response.text();
        
        // Hide spinner and update persistent output
        status.style.display = "none";
        // Extracting just the PRE content from the returned HTML if necessary
        // Or simply setting the result if your Go backend returns just the string
        output.textContent = result;
    } catch (err) {
        status.style.display = "none";
        output.textContent = "Error: " + err;
    }
}

let markers = [];
let polyline = null;

function updateMap(coords) {
    // 1. Remove existing markers and lines
    markers.forEach(m => map.removeLayer(m));
    if (polyline) map.removeLayer(polyline);
    markers = [];

    if (!coords || coords.length === 0) return;

    const latLngs = [];

    // 2. Create markers for each hop
    coords.forEach((c, index) => {
        const point = [c.lat, c.lon];
        latLngs.push(point);

        const marker = L.circleMarker(point, {
            radius: 5,
            fillColor: index === coords.length - 1 ? "#ff0000" : "#0056b3",
            color: "#fff",
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
        }).addTo(map).bindPopup(`Hop ${index + 1}: ${c.ip}`);
        
        markers.push(marker);
    });

    // 3. Draw the path line
    polyline = L.polyline(latLngs, {color: '#0056b3', weight: 2, dashArray: '5, 10'}).addTo(map);

    // 4. Zoom to fit the whole path
    const group = new L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.1));
}
</script>
{{end}}